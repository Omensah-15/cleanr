#!/usr/bin/env bash
# cleanr - Clean CSVs instantly
# Works in Git Bash, Linux, macOS

set -euo pipefail

# Configuration
VERSION="2.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PYTHON_SCRIPT="$SCRIPT_DIR/cleanr.py"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Default paths
DEFAULT_OUTPUT="./cleaned"
DEFAULT_PROFILES="$SCRIPT_DIR/profiles"

# Ensure Python is available
check_python() {
    if ! command -v python3 >/dev/null 2>&1; then
        echo -e "${RED}Error: Python 3 not found${NC}"
        echo "Install Python 3 or ensure it is in your PATH"
        exit 1
    fi
}

# Help message
show_help() {
    cat << EOF
CleanR v${VERSION} - CSV Cleaner

Usage:
  cleanr <input.csv> [output.csv] [options]

Quick start:
  cleanr messy.csv
  cleanr sales.csv --profile sales
  cleanr large.csv --quick --stats

Cleaning options:
  -t, --trim               Trim whitespace
  -d, --dedup              Remove duplicates
  -n, --normalize          Normalize column names
  -f, --fill VALUE         Fill missing values
  --drop-na                Drop rows with missing values
  --keep "a,b,c"           Keep specific columns
  --drop "x,y,z"           Drop specific columns
  --encoding ENC           Force encoding

Performance:
  --quick                  Skip type inference
  --chunk SIZE             Process in chunks
  --memory                 Show memory usage

Profiles:
  --profile NAME           Use profile
  --list-profiles          List profiles
  --create-profile NAME    Create profile template

Output:
  --stats                  Show statistics
  --dry-run                Preview changes
  --backup                 Keep original file

Profiles directory: $DEFAULT_PROFILES
Output directory:   $DEFAULT_OUTPUT
EOF
}

# List profiles
list_profiles() {
    echo -e "${YELLOW}Available profiles:${NC}"

    if [[ ! -d "$DEFAULT_PROFILES" ]]; then
        echo "No profiles found"
        return
    fi

    for profile in "$DEFAULT_PROFILES"/*.yaml; do
        [[ -f "$profile" ]] || continue
        name="$(basename "$profile" .yaml)"
        desc="$(grep -E '^description:' "$profile" | head -1 | cut -d: -f2- | sed 's/^ *//')"
        echo "  $name: ${desc:-No description}"
    done
}

# Create profile template
create_profile() {
    local name="$1"
    local profile_file="$DEFAULT_PROFILES/$name.yaml"

    mkdir -p "$DEFAULT_PROFILES"

    cat > "$profile_file" << EOF
# CleanR Profile: $name
# Created: $(date)

description: "Cleaning profile for $name data"

trim_whitespace: true
remove_duplicates: true
normalize_columns: true

fill_missing: ""
drop_missing_rows: false

keep_columns:
  - id
  - name
  - date
  - amount

drop_columns:
  - password
  - ssn

rename_columns:
  "Old Name": "new_name"

convert_types:
  amount: float
  quantity: int
EOF

    echo -e "${GREEN}Profile created:${NC} $profile_file"
}

# Generate output filename
generate_output_name() {
    local input="$1"
    local base="$(basename "$input")"
    local name="${base%.*}"
    local ext="${base##*.}"
    local timestamp
    timestamp="$(date +%Y%m%d_%H%M%S)"

    mkdir -p "$DEFAULT_OUTPUT"
    echo "$DEFAULT_OUTPUT/${name}_clean_${timestamp}.${ext}"
}

# Main
main() {
    check_python

    case "${1:-}" in
        -h|--help) show_help; exit 0 ;;
        -v|--version) echo "CleanR v$VERSION"; exit 0 ;;
        --list-profiles) list_profiles; exit 0 ;;
        --create-profile)
            [[ -n "${2:-}" ]] || { echo "Profile name required"; exit 1; }
            create_profile "$2"
            exit 0
            ;;
    esac

    [[ $# -gt 0 ]] || { echo "Input file required"; exit 1; }

    local input_file="$1"
    shift

    [[ -f "$input_file" ]] || { echo "File not found: $input_file"; exit 1; }

    local output_file
    if [[ $# -gt 0 && ! "$1" =~ ^- ]]; then
        output_file="$1"
        shift
    else
        output_file="$(generate_output_name "$input_file")"
    fi

    mkdir -p "$(dirname "$output_file")"

    local python_cmd
    python_cmd=(python3 "$PYTHON_SCRIPT" "$input_file" "$output_file" "$@")

    echo -e "${BLUE}Processing:${NC} $(basename "$input_file")"
    "${python_cmd[@]}"

    echo -e "${GREEN}Completed:${NC} $output_file"
}

main "$@"
